# Arduino Due w/ SAM3X8E

# external stlink-v2
source [find /interface/stlink.cfg]

# transport type SWD
transport select hla_swd

# swd frequency
adapter speed 4000

# sam3x8e cpuid
set CPUTAPID 0x2ba01477

set WORKAREASIZE 0x10000

source [find target/at91sam3XXX.cfg]

# flash bank 0
set _FLASHNAME $_CHIPNAME.flash0
flash bank $_FLASHNAME at91sam3 0x00080000 0 1 1 $_TARGETNAME

# flash bank 1
set _FLASHNAME $_CHIPNAME.flash1
flash bank $_FLASHNAME at91sam3 0x000C0000 0 1 1 $_TARGETNAME

# W25Q128
set a [llength [flash list]]
flash bank $_CHIPNAME.w25q128 cmspi 0x90000000 0 0 0 $_TARGETNAME \
	0x004 0x400E0E38  4 0x400E0E38 16 \
	0x400E0E38 24 0x3DC 0x3D8 0x01000000 0x400E0E38  6 0x3DC 0x3D8 0x00000040

# W25Q256
set b [llength [flash list]]
flash bank $_CHIPNAME.w25q256 cmspi 0x91000000 0 0 0 $_TARGETNAME \
	0x004 0x400E0E38 23 0x400E0E38 16 \
	0x400E0E38 24 0x3DC 0x3D8 0x01000000 0x400E0E38  6 0x3DC 0x3D8 0x00000040

# M95640
set c [llength [flash list]]
flash bank $_CHIPNAME.m95640 cmspi 0x93000000 0 0 0 $_TARGETNAME \
	0x004 0x400E1238 23 0x400E0E38 16 \
	0x400E0E38 24 0x3DC 0x3D8 0x01000000 0x400E0E38  6 0x3DC 0x3D8 0x00000040

# M95M02
set d [llength [flash list]]
flash bank $_CHIPNAME.m95m02 cmspi 0x93002000 0 0 0 $_TARGETNAME \
	0x004 0x400E1038 25 0x400E0E38 16 \
	0x400E0E38 24 0x3DC 0x3D8 0x01000000 0x400E0E38  6 0x3DC 0x3D8 0x00000040

# M95512
set e [llength [flash list]]
flash bank $_CHIPNAME.m95512 cmspi 0x93042000 0 0 0 $_TARGETNAME \
	0x004 0x400E0E38 22 0x400E0E38 16 \
	0x400E0E38 24 0x3DC 0x3D8 0x01000000 0x400E0E38  6 0x3DC 0x3D8 0x00000040

# FM25W256
set f [llength [flash list]]
flash bank $_CHIPNAME.fm25w256 cmspi 0x93052000 0 0 0 $_TARGETNAME \
	0x004 0x400E1238 28 0x400E0E38 16 \
	0x400E0E38 24 0x3DC 0x3D8 0x01000000 0x400E0E38  6 0x3DC 0x3D8 0x00000040

# MB85RS64
set g [llength [flash list]]
flash bank $_CHIPNAME.mb85rs64 cmspi 0x9305A000 0 0 0 $_TARGETNAME \
	0x004 0x400E1238 25 0x400E0E38 16 \
	0x400E0E38 24 0x3DC 0x3D8 0x01000000 0x400E0E38  6 0x3DC 0x3D8 0x00000040

# FM25V02
#
# MOSI and MISO pins *both* connected to PA06, hence exor mask
# for MISO is 0x00000000 rather than 0x000000B0
#
set h [llength [flash list]]
flash bank $_CHIPNAME.fm25v02 cmspi 0x9305C000 0 0 0 $_TARGETNAME \
	0x004 0x400E1238 26 0x400E0E38 16 \
	0x400E0E38  6 0x3DC 0x3D8 0x00000000 0x400E0E38  6 0x3DC 0x3D8 0x00000040

# FM25V05
set i [llength [flash list]]
flash bank $_CHIPNAME.fm25v05 cmspi 0x93064000 0 0 0 $_TARGETNAME \
	0x004 0x400E1238 24 0x400E0E38 16 \
	0x400E0E38 24 0x3DC 0x3D8 0x01000000 0x400E0E38  6 0x3DC 0x3D8 0x00000040

proc cmspi_init { } {
	global a b c d e f g h i
	# disable watchdog
	mww 0x400E1A54 0x3FFFAFFF	;# WDT_MR: WDIS=1

	# disable write protection
	mww 0x400E06E4 0x504D4300	;# PMC_WPMR: WPEN=0

	# main on-chip rc oscillator at 8 MHz
	mww 0x400E0620 0x00371018	;# CKGR_MOR: MOSCSEL=0, MOSCXTST=16, MOSCRCF=0x1, MOSCRCEN=1

	# set PLLA output to 80 MHz
	mww 0x400E0628 0x20090A01	;# CKGR_PLLAR: MULA=9, PLLACOUNT=10, DIVA=1
	sleep 10

	# switch to PLLA
	mww 0x400E0630 0x00000002	;# PMC_MCKR: PRES=/1, CSS=PLLA_CLK

	# enable PIO clocks: PIDs 11-16 refer to PIOA-F
	mww 0x400E0610 0x0001F800	;# PMC_PCER0 = PID16|PID15|PID14|PID13|PID12|PID11

	adapter speed 4000

	# W25Q128, A5=NCS: PA04, A0=SCLK: PA16, A1=IO01/MISO: PA24, A4=IO00/MOSI: PA06
	# PA24:INPUP:H, PA16:PP:H, PA06:INPUP:H, PA04:PPUP:L
	# Port A: PA24:INPUP:H, PA16:PP:H, PA06:INPUP:H, PA04:PPUP:L
	mww 0x400E0E00 0x01010050	;# PIO_PER
	mww 0x400E0EA0 0x01010050	;# PIO_OWER
	mww 0x400E0E10 0x00010010	;# PIO_OER
	mww 0x400E0E30 0x01000050	;# PIO_SODR
	mww 0x400E0E64 0x01000050	;# PIO_PUER

	# W25Q256, A2=NCS: PA23, A0=SCLK: PA16, A1=IO01/MISO: PA24, A4=IO00/MOSI: PA06
	# PA24:INPUP:H, PA23:PPUP:L, PA16:PP:H, PA06:INPUP:H
	# Port A: PA24:INPUP:H, PA23:PPUP:L, PA16:PP:H, PA06:INPUP:H
	mww 0x400E0E00 0x01810040	;# PIO_PER
	mww 0x400E0EA0 0x01810040	;# PIO_OWER
	mww 0x400E0E10 0x00810000	;# PIO_OER
	mww 0x400E0E30 0x01800040	;# PIO_SODR
	mww 0x400E0E64 0x01800040	;# PIO_PUER

	# M95640, D7=NCS: PC23, A0=SCLK: PA16, A1=IO01/MISO: PA24, A4=IO00/MOSI: PA06
	# PA24:INPUP:H, PA16:PP:H, PA06:INPUP:H, PC23:PPUP:L
	# Port A: PA24:INPUP:H, PA16:PP:H, PA06:INPUP:H
	mww 0x400E0E00 0x01010040	;# PIO_PER
	mww 0x400E0EA0 0x01010040	;# PIO_OWER
	mww 0x400E0E10 0x00010000	;# PIO_OER
	mww 0x400E0E30 0x01000040	;# PIO_SODR
	mww 0x400E0E64 0x01000040	;# PIO_PUER
	# Port C: PC23:PPUP:L
	mww 0x400E1200 0x00800000	;# PIO_PER
	mww 0x400E12A0 0x00800000	;# PIO_OWER
	mww 0x400E1210 0x00800000	;# PIO_OER
	mww 0x400E1230 0x00800000	;# PIO_SODR
	mww 0x400E1264 0x00800000	;# PIO_PUER

	# M95M02, D2=NCS: PB25, A0=SCLK: PA16, A1=IO01/MISO: PA24, A4=IO00/MOSI: PA06
	# PA24:INPUP:H, PA16:PP:H, PA06:INPUP:H, PB25:PPUP:L
	# Port A: PA24:INPUP:H, PA16:PP:H, PA06:INPUP:H
	mww 0x400E0E00 0x01010040	;# PIO_PER
	mww 0x400E0EA0 0x01010040	;# PIO_OWER
	mww 0x400E0E10 0x00010000	;# PIO_OER
	mww 0x400E0E30 0x01000040	;# PIO_SODR
	mww 0x400E0E64 0x01000040	;# PIO_PUER
	# Port B: PB25:PPUP:L
	mww 0x400E1000 0x02000000	;# PIO_PER
	mww 0x400E10A0 0x02000000	;# PIO_OWER
	mww 0x400E1010 0x02000000	;# PIO_OER
	mww 0x400E1030 0x02000000	;# PIO_SODR
	mww 0x400E1064 0x02000000	;# PIO_PUER

	# M95512, A3=NCS: PA22, A0=SCLK: PA16, A1=IO01/MISO: PA24, A4=IO00/MOSI: PA06
	# PA24:INPUP:H, PA22:PPUP:L, PA16:PP:H, PA06:INPUP:H
	# Port A: PA24:INPUP:H, PA22:PPUP:L, PA16:PP:H, PA06:INPUP:H
	mww 0x400E0E00 0x01410040	;# PIO_PER
	mww 0x400E0EA0 0x01410040	;# PIO_OWER
	mww 0x400E0E10 0x00410000	;# PIO_OER
	mww 0x400E0E30 0x01400040	;# PIO_SODR
	mww 0x400E0E64 0x01400040	;# PIO_PUER

	# FM25W256, D3=NCS: PC28, A0=SCLK: PA16, A1=IO01/MISO: PA24, A4=IO00/MOSI: PA06
	# PA24:INPUP:H, PA16:PP:H, PA06:INPUP:H, PC28:PPUP:L
	# Port A: PA24:INPUP:H, PA16:PP:H, PA06:INPUP:H
	mww 0x400E0E00 0x01010040	;# PIO_PER
	mww 0x400E0EA0 0x01010040	;# PIO_OWER
	mww 0x400E0E10 0x00010000	;# PIO_OER
	mww 0x400E0E30 0x01000040	;# PIO_SODR
	mww 0x400E0E64 0x01000040	;# PIO_PUER
	# Port C: PC28:PPUP:L
	mww 0x400E1200 0x10000000	;# PIO_PER
	mww 0x400E12A0 0x10000000	;# PIO_OWER
	mww 0x400E1210 0x10000000	;# PIO_OER
	mww 0x400E1230 0x10000000	;# PIO_SODR
	mww 0x400E1264 0x10000000	;# PIO_PUER

	# MB85RS64, D5=NCS: PC25, A0=SCLK: PA16, A1=IO01/MISO: PA24, A4=IO00/MOSI: PA06
	# PA24:INPUP:H, PA16:PP:H, PA06:INPUP:H, PC25:PPUP:L
	# Port A: PA24:INPUP:H, PA16:PP:H, PA06:INPUP:H
	mww 0x400E0E00 0x01010040	;# PIO_PER
	mww 0x400E0EA0 0x01010040	;# PIO_OWER
	mww 0x400E0E10 0x00010000	;# PIO_OER
	mww 0x400E0E30 0x01000040	;# PIO_SODR
	mww 0x400E0E64 0x01000040	;# PIO_PUER
	# Port C: PC25:PPUP:L
	mww 0x400E1200 0x02000000	;# PIO_PER
	mww 0x400E12A0 0x02000000	;# PIO_OWER
	mww 0x400E1210 0x02000000	;# PIO_OER
	mww 0x400E1230 0x02000000	;# PIO_SODR
	mww 0x400E1264 0x02000000	;# PIO_PUER

	# FM25V02, D4=NCS: PC26, A0=SCLK: PA16, A1=IO01/MISO: PA24, A4=IO00/MOSI: PA06
	#
	# MOSI and MISO pins *both* connected to PA06, hence PA24 actually not used
	#
	# PA24:INPUP:H, PA16:PP:H, PA06:INPUP:H, PC26:PPUP:L
	# Port A: PA24:INPUP:H, PA16:PP:H, PA06:INPUP:H
	mww 0x400E0E00 0x01010040	;# PIO_PER
	mww 0x400E0EA0 0x01010040	;# PIO_OWER
	mww 0x400E0E10 0x00010000	;# PIO_OER
	mww 0x400E0E30 0x01000040	;# PIO_SODR
	mww 0x400E0E64 0x01000040	;# PIO_PUER
	# Port C: PC26:PPUP:L
	mww 0x400E1200 0x04000000	;# PIO_PER
	mww 0x400E12A0 0x04000000	;# PIO_OWER
	mww 0x400E1210 0x04000000	;# PIO_OER
	mww 0x400E1230 0x04000000	;# PIO_SODR
	mww 0x400E1264 0x04000000	;# PIO_PUER

	# FM25V05, D6=NCS: PC24, A0=SCLK: PA16, A1=IO01/MISO: PA24, A4=IO00/MOSI: PA06
	# PA24:INPUP:H, PA16:PP:H, PA06:INPUP:H, PC24:PPUP:L
	# Port A: PA24:INPUP:H, PA16:PP:H, PA06:INPUP:H
	mww 0x400E0E00 0x01010040	;# PIO_PER
	mww 0x400E0EA0 0x01010040	;# PIO_OWER
	mww 0x400E0E10 0x00010000	;# PIO_OER
	mww 0x400E0E30 0x01000040	;# PIO_SODR
	mww 0x400E0E64 0x01000040	;# PIO_PUER
	# Port C: PC24:PPUP:L
	mww 0x400E1200 0x01000000	;# PIO_PER
	mww 0x400E12A0 0x01000000	;# PIO_OWER
	mww 0x400E1210 0x01000000	;# PIO_OER
	mww 0x400E1230 0x01000000	;# PIO_SODR
	mww 0x400E1264 0x01000000	;# PIO_PUER

	#cmspi set $a w25q128 0x1000000 0x100 0x03 0x00 0x02 0xC7 0x10000 0xD8
	#cmspi set $b w25q256fv 0x2000000 0x100 0x03 0x00 0x02 0xC7 0x10000 0xD8
	cmspi cmd $b 1 0x15; cmspi cmd $b 0 0xB7; cmspi cmd $b 1 0x15
	cmspi set $c m95640 0x2000 0x20 0x03 0x00 0x02
	cmspi set $d m95m02 0x40000 0x100 0x03 0x00 0x02
	cmspi set $e m95512 0x10000 0x80 0x03 0x00 0x02
	cmspi set $f fm25w256 0x8000 0x100 0x03 0x00 0x02
	#cmspi set $g mb85rs64 0x2000 0x100 0x03 0x00 0x02
	#cmspi set $h fm25v02 0x8000 0x100 0x03 0x00 0x02
	#cmspi set $i fm25v05 0x10000 0x100 0x03 0x00 0x02
}

$_TARGETNAME configure -event reset-init {
	cmspi_init
}


