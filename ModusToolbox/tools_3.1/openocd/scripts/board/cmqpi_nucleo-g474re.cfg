# Sample configs for SPI Flash Nucleo-G474RE

# This is for using the onboard STLINK/V3
source [find interface/stlink.cfg]

transport select hla_swd

set WORKAREASIZE 0x8000

source [find target/stm32g4x.cfg]

# W25Q256-A
set a [llength [flash list]]
flash bank $_CHIPNAME.w25q256-a cmspi 0x90000000 0 0 0 $_TARGETNAME \
	0x3FC 0x48000414 11 0x48000414 10 \
	0x48000014  6 0x3EC 0x3EC 0x00001000 0x48000014  7 0x3EC 0x3EC 0x00004000 \
	0x48000414  0 0x3EC 0x3EC 0x00000001 0x48000414  1 0x3EC 0x3EC 0x00000004

# W25Q256-B
set b [llength [flash list]]
flash bank $_CHIPNAME.w25q256-b cmspi 0x91000000 0 0 0 $_TARGETNAME \
	0x3FC 0x48000414 11 0x48000414 10 \
	0x48000814  4 0x3EC 0x3EC 0x00000100 0x48000814  3 0x3EC 0x3EC 0x00000040 \
	0x48000814  2 0x3EC 0x3EC 0x00000010 0x48000814  1 0x3EC 0x3EC 0x00000004

proc cmspi_init { } {
	global a b
	mmw 0x4002104C 0x0000007F 0				;# RCC_AHB2ENR |= GPIOA-GPIOG (enable clocks)

	# NCS: PB11, SCLK: PB10, IO03/NHOLD: PA06, IO02/NWP: PA07, IO01/MISO: PB00, IO00/MOSI: PB01

	# PA07:INPUP:V, PA06:INPUP:V, PB11:PPUP:H, PB10:PPUP:V, PB01:INPUP:V, PB00:INPUP:V
	# Port A: PA07:INPUP:V, PA06:INPUP:V
	mmw 0x48000000 0x00000000 0x0000F000	;# MODER
	mmw 0x48000004 0x00000000 0x000000C0	;# OTYPER
	mmw 0x48000008 0x0000F000 0x00000000	;# OSPEEDR
	mmw 0x4800000C 0x00005000 0x0000A000	;# PUPDR
	mmw 0x48000014 0x000000C0 0x00000000	;# ODR
	# Port B: PB11:PPUP:H, PB10:PPUP:V, PB01:INPUP:V, PB00:INPUP:V
	mmw 0x48000400 0x00500000 0x00A0000F	;# MODER
	mmw 0x48000404 0x00000000 0x00000C03	;# OTYPER
	mmw 0x48000408 0x00B0000F 0x00400000	;# OSPEEDR
	mmw 0x4800040C 0x00500005 0x00A0000A	;# PUPDR
	mmw 0x48000414 0x00000C03 0x00000000	;# ODR

	# NCS: PB11, SCLK: PB10, IO03/NHOLD: PC04, IO02/NWP: PC03, IO01/MISO: PC02, IO00/MOSI: PC01

	# PB11:PPUP:H, PB10:PPUP:V, PC04:INPUP:V, PC03:INPUP:V, PC02:INPUP:V, PC01:INPUP:V
	# Port B: PB11:PPUP:H, PB10:PPUP:V
	mmw 0x48000400 0x00500000 0x00A00000	;# MODER
	mmw 0x48000404 0x00000000 0x00000C00	;# OTYPER
	mmw 0x48000408 0x00B00000 0x00400000	;# OSPEEDR
	mmw 0x4800040C 0x00500000 0x00A00000	;# PUPDR
	mmw 0x48000414 0x00000C00 0x00000000	;# ODR
	# Port C: PC04:INPUP:V, PC03:INPUP:V, PC02:INPUP:V, PC01:INPUP:V
	mmw 0x48000800 0x00000000 0x000003FC	;# MODER
	mmw 0x48000804 0x00000000 0x0000001E	;# OTYPER
	mmw 0x48000808 0x000003FC 0x00000000	;# OSPEEDR
	mmw 0x4800080C 0x00000154 0x000002A8	;# PUPDR
	mmw 0x48000814 0x0000001E 0x00000000	;# ODR

	#cmspi set $a w25q256fv 0x2000000 0x100 0x03 0xEB 0x02 0xC7 0x10000 0xD8
	# exit QPI mode, enter 4-byte mode, enter QPI mode, show status register 3 and 2
	cmspi cmd $a 0 0xFF; cmspi cmd $a 1 0x15; cmspi cmd $a 0 0xB7; cmspi cmd $a 1 0x15
	cmspi cmd $a 0 0x38; cmspi qpi $a 2; cmspi cmd $a 1 0x35

	#cmspi set $b w25q256fv 0x2000000 0x100 0x03 0xEB 0x02 0xC7 0x10000 0xD8
	# exit QPI mode, enter 4-byte mode, enter QPI mode, show status register 3 and 2
	cmspi cmd $b 0 0xFF; cmspi cmd $b 1 0x15; cmspi cmd $b 0 0xB7; cmspi cmd $b 1 0x15
	cmspi cmd $b 0 0x38; cmspi qpi $b 2; cmspi cmd $b 1 0x35
}

$_TARGETNAME configure -event reset-init {
	mmw 0x40022000 0x00000007 0x00000008	;# FLASH_ACR: 7 WS for 144 MHz HCLK
	sleep 1
	mmw 0x40021000 0x00000100 0x00000000	;# RCC_CR: HSI on
	mww 0x4002100C 0x01004832				;# RCC_PLLCFGR: 144 MHz PLLREN=1, PLLM=4, PLLN=72, PLLR=2, HSI
	mww 0x40021008 0x00008001				;# RCC_CFGR: HSI16, APB1: /1, APB2: /1
	mmw 0x40021000 0x01000000 0x00000000	;# RCC_CR: PLL on
	sleep 1
	mmw 0x40021008 0x00000003 0x00000000	;# RCC_CFGR: switch to PLL
	sleep 1

	adapter speed 24000

	cmspi_init
}

