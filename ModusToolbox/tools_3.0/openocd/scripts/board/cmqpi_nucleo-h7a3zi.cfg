# This is an nucleo-h7a3zi with a single STM32H7A3ZIT6U chip.
# http://www.st.com/en/evaluation-tools/nucleo-h7a3zi.html
#
# Two Winbond W25Q256FV attached, dual-1-line or dual-4-line mode
#

# This is for using the onboard STLINK
source [find interface/stlink.cfg]

#hla_vid_pid 0x0483 0x3748

transport select hla_swd

# increase working area to 256KB
set WORKAREASIZE 0x40000

source [find target/stm32h7x_dual_bank.cfg]

reset_config none

# W25Q256-A
set a [llength [flash list]]
flash bank $_CHIPNAME.w25q256-a cmspi 0x90000000 0 0 0 $_CHIPNAME.cpu0 \
	0x3FC 0x58020414 10 0x58020414  2 \
	0x58020C14 13 0x3EC 0x3EC 0x04000000 0x58021014  2 0x3EC 0x3EC 0x00000010 \
	0x58020C14 12 0x3EC 0x3EC 0x01000000 0x58020C14 11 0x3EC 0x3EC 0x00400000

# W25Q256-B
set b [llength [flash list]]
flash bank $_CHIPNAME.w25q256-b cmspi 0x91000000 0 0 0 $_CHIPNAME.cpu0 \
	0x3FC 0x58020814 11 0x58020414  2 \
	0x58021014 10 0x3EC 0x3EC 0x00100000 0x58020C14  6 0x3EC 0x3EC 0x00001000 \
	0x58021014  8 0x3EC 0x3EC 0x00010000 0x58021014  7 0x3EC 0x3EC 0x00004000

proc cmqpi_init { } {
	global a b
	mmw 0x580244E0 0x000007FF 0				;# RCC_AHB4ENR |= GPIOA-GPIOK (enable clocks)
	sleep 1									;# Wait for clock startup

	# PB10: BK1_NCS, PB02: CLK, PD13: BK1_IO3, PE02: BK1_IO2, PD12: BK1_IO1, PD11: BK1_IO0
	# PB10:PPUP:M, PB02:PPUP:V, PD13:INPUP:V, PD12:INPUP:V, PD11:INPUP:V, PE02:INPUP:V
	# Port B: PB10:PPUP:M, PB02:PPUP:V
	mmw 0x58020400 0x00100010 0x00200020	;# MODER
	mmw 0x58020404 0x00000000 0x00000404	;# OTYPER
	mmw 0x58020408 0x00100030 0x00200000	;# OSPEEDR
	mmw 0x5802040C 0x00100010 0x00200020	;# PUPDR
	mmw 0x58020414 0x00000404 0x00000000	;# ODR
	# Port D: PD13:INPUP:V, PD12:INPUP:V, PD11:INPUP:V
	mmw 0x58020C00 0x00000000 0x0FC00000	;# MODER
	mmw 0x58020C04 0x00000000 0x00003800	;# OTYPER
	mmw 0x58020C08 0x0FC00000 0x00000000	;# OSPEEDR
	mmw 0x58020C0C 0x05400000 0x0A800000	;# PUPDR
	mmw 0x58020C14 0x00003800 0x00000000	;# ODR
	# Port E: PE02:INPUP:V
	mmw 0x58021000 0x00000000 0x00000030	;# MODER
	mmw 0x58021004 0x00000000 0x00000004	;# OTYPER
	mmw 0x58021008 0x00000030 0x00000000	;# OSPEEDR
	mmw 0x5802100C 0x00000010 0x00000020	;# PUPDR
	mmw 0x58021014 0x00000004 0x00000000	;# ODR

	# PC11: BK2_NCS, PB02: CLK, PE10: BK2_IO3, PD06: BK2_IO2, PE08: BK2_IO1, PE07: BK2_IO0
	# PB02:PPUP:V, PC11:PPUP:M, PD06:INPUP:V, PE10:INPUP:V, PE08:INPUP:V, PE07:INPUP:V
	# Port B: PB02:PPUP:V
	mmw 0x58020400 0x00000010 0x00000020	;# MODER
	mmw 0x58020404 0x00000000 0x00000004	;# OTYPER
	mmw 0x58020408 0x00000030 0x00000000	;# OSPEEDR
	mmw 0x5802040C 0x00000010 0x00000020	;# PUPDR
	mmw 0x58020414 0x00000004 0x00000000	;# ODR
	# Port C: PC11:PPUP:M
	mmw 0x58020800 0x00400000 0x00800000	;# MODER
	mmw 0x58020804 0x00000000 0x00000800	;# OTYPER
	mmw 0x58020808 0x00400000 0x00800000	;# OSPEEDR
	mmw 0x5802080C 0x00400000 0x00800000	;# PUPDR
	mmw 0x58020814 0x00000800 0x00000000	;# ODR
	# Port D: PD06:INPUP:V
	mmw 0x58020C00 0x00000000 0x00003000	;# MODER
	mmw 0x58020C04 0x00000000 0x00000040	;# OTYPER
	mmw 0x58020C08 0x00003000 0x00000000	;# OSPEEDR
	mmw 0x58020C0C 0x00001000 0x00002000	;# PUPDR
	mmw 0x58020C14 0x00000040 0x00000000	;# ODR
	# Port E: PE10:INPUP:V, PE08:INPUP:V, PE07:INPUP:V
	mmw 0x58021000 0x00000000 0x0033C000	;# MODER
	mmw 0x58021004 0x00000000 0x00000580	;# OTYPER
	mmw 0x58021008 0x0033C000 0x00000000	;# OSPEEDR
	mmw 0x5802100C 0x00114000 0x00228000	;# PUPDR
	mmw 0x58021014 0x00000580 0x00000000	;# ODR

	#cmspi set $a w25q256fv 0x2000000 0x100 0x03 0xEB 0x02 0xC7 0x10000 0xD8
	# exit QPI mode, enter 4-byte mode, enter QPI mode, show status register 3 and 2
	cmspi cmd $a 0 0xFF; cmspi cmd $a 1 0x15; cmspi cmd $a 0 0xB7; cmspi cmd $a 1 0x15
	cmspi cmd $a 0 0x38; cmspi qpi $a 2; cmspi cmd $a 1 0x35

	#cmspi set $b w25q256fv 0x2000000 0x100 0x03 0xEB 0x02 0xC7 0x10000 0xD8
	# exit QPI mode, enter 4-byte mode, enter QPI mode, show status register 3 and 2
	cmspi cmd $b 0 0xFF; cmspi cmd $b 1 0x15; cmspi cmd $b 0 0xB7; cmspi cmd $b 1 0x15
	cmspi cmd $b 0 0x38; cmspi qpi $b 2; cmspi cmd $b 1 0x35
}

$_CHIPNAME.cpu0 configure -event reset-init {
	mww 0x52002000 0x00000034				;# FLASH_ACR: 4 WS for 192 MHZ HCLK

	mmw 0x58024400 0x00000001 0x00000018	;# RCC_CR: HSIDIV=1, HSI on
	mmw 0x58024410 0x10000000 0xEE000007	;# RCC_CFGR: MCO2=system, MCO2PRE=8, HSI as system clock
	mww 0x58024418 0x00000040				;# RCC_D1CFGR: D1CPRE=1, D1PPRE=2, HPRE=1
	mww 0x5802441C 0x00000440				;# RCC_D2CFGR: D2PPRE2=2, D2PPRE1=2
	mww 0x58024420 0x00000040				;# RCC_D3CFGR: D3PPRE=2
	mww 0x58024428 0x00000040				;# RCC_PPLCKSELR: DIVM3=0, DIVM2=0, DIVM1=4, PLLSRC=HSI
	mmw 0x5802442C 0x0001000C 0x00000002	;# RCC_PLLCFGR: PLL1RGE=8MHz to 16MHz, PLL1VCOSEL=wide
	mww 0x58024430 0x01070217				;# RCC_PLL1DIVR: 192 MHz: DIVR1=2, DIVQ=8, DIVP1=2, DIVN1=24
	mmw 0x58024400 0x01000000 0				;# RCC_CR: PLL1ON=1
	sleep 1
	mmw 0x58024410 0x00000003 0				;# RCC_CFGR: PLL1 as system clock
	sleep 1

	adapter speed 24000

	cmqpi_init
}
